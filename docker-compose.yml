version: "3.8"

services:
  test-core:
    container_name: test
    build:
      context: .
      dockerfile: ./src/contexts/shared/core/Dockerfile
    environment:
      - MONGO_DB_URL=mongodb://mongodb:27017/test
      - RABBIT_MQ_URL=amqp://rabbitmq:5672
      - REDIS_URL=redis://redis:6379
    depends_on:
      - mongodb
      - redis
      - rabbitmq
    command: npm run test -w core
  test-hospital:
    build:
      context: .
      dockerfile: ./src/contexts/hospital/Dockerfile
    environment:
      - MONGO_DB_URL=mongodb://mongodb:27017/test
    depends_on:
      - mongodb
    command: npm run test -w hospital
  hospital-api:
    build:
      context: .
      dockerfile: ./src/apps/hospital/api/Dockerfile
    ports:
      - "3001:3000"
    depends_on:
      - mongodb
      - redis
      - rabbitmq
      - grafana
    command: npm run start:test -w api
  mongodb:
    image: mongo
    ports:
      - "27018:27017"
  redis:
    image: redis
    logging:
      driver: none
    ports:
      - "6378:6379"
  rabbitmq:
    image: rabbitmq:management
    ports:
      - "5673:5672"
      - "15673:15672"
    logging:
      driver: none
  grafana:
    image: grafana/grafana:latest
    ports:
      - '3000:3000'
    volumes:
      - grafana-data:/var/lib/grafana
    depends_on:
      - loki
      - tempo
      - prometheus
  loki:
    image: grafana/loki:latest
    ports:
      - '3100:3100'
    volumes:
      - loki-data:/tmp/loki
  tempo:
    image: grafana/tempo:latest
    ports:
      - "14268:14268" # jaeger ingest
      - "3200:3200"  # tempo
      - "4317:4317"  # otlp grpc
      - "4318:4318"  # otlp http
    command: [ "-config.file=/etc/tempo.yaml" ]
    volumes:
      - tempo-data:/tmp/tempo
      - ./etc/tempo.yaml:/etc/tempo.yaml
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./etc/prometheus.yaml:/etc/prometheus.yaml
    command:
      - --config.file=/etc/prometheus.yaml
      - --web.enable-remote-write-receiver
      - --enable-feature=exemplar-storage
    ports:
      - "9090:9090"
networks:
  monitoring:
volumes:
  grafana-data:
  loki-data:
  tempo-data:
